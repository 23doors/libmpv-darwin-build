version: "3"

vars:
  PWD:
    sh: pwd
  TERM:
    sh: echo $TERM
  VERSION:
    sh: echo ${VERSION:-develop}
  UNSETENV: |
    # unset all env vars
    for i in $(env | awk -F"=" '{print $1}') ; do unset $i ; done
  PROJECT_DIR: "{{.PWD}}"
  BUILD_DIR: "{{.PROJECT_DIR}}/build"
  TOOLS_DIR: "{{.BUILD_DIR}}/tools"
  TOOLS_PREFIX: "{{.TOOLS_DIR}}/chroot"
  TOOLS_SOURCES_DIR: "{{.TOOLS_DIR}}/sources"
  PATH: /bin:/usr/bin:{{.TOOLS_PREFIX}}/bin

tasks:
  default:
    deps:
      - build-macos
      - build-ios
      - build-iossimulator

  build-macos:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-macos-universal
      - archives-macos-amd64
      - archives-macos-arm64

  build-macos-universal:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-macos-universal

  build-macos-amd64:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-macos-amd64

  build-macos-arm64:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-macos-arm64

  build-ios:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-ios-universal
      - archives-ios-arm64

  build-ios-arm64:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-ios-arm64

  build-iossimulator:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-iossimulator-universal
      - archives-iossimulator-amd64
      - archives-iossimulator-arm64

  build-iossimulator-universal:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-iossimulator-universal

  build-iossimulator-amd64:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-iossimulator-amd64

  build-iossimulator-arm64:
    run: once
    platforms:
      - darwin
    deps:
      - tool-versions-lock
      - archives-iossimulator-arm64

  tool-versions-lock:
    internal: true
    run: once
    cmds:
      - |
        set -e

        CONTENT=$(go run cmd/tool-versions/main.go)
        echo "$CONTENT" > "{{.BUILD_DIR}}"/tool-versions.lock

  archives-macos-universal:
    internal: true
    run: once
    vars:
      OS: macos
      ARCH: universal
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-macos-universal
      - xcframeworks-macos-universal
    cmds:
      - task: archives-libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"
      - task: archives-xcframeworks
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-macos-amd64:
    internal: true
    run: once
    vars:
      OS: macos
      ARCH: amd64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-macos-amd64
    cmds:
      - task: archives-libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-macos-arm64:
    internal: true
    run: once
    vars:
      OS: macos
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-macos-arm64
    cmds:
      - task: archives-libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-ios-universal:
    internal: true
    run: once
    vars:
      OS: ios
      ARCH: universal
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - xcframeworks-ios-universal
    cmds:
      - task: archives-xcframeworks
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-ios-arm64:
    internal: true
    run: once
    vars:
      OS: ios
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-ios-arm64
    cmds:
      - task: archives-libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-iossimulator-universal:
    internal: true
    run: once
    vars:
      OS: iossimulator
      ARCH: universal
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-iossimulator-universal
    cmds:
      - task: archives-libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-iossimulator-amd64:
    internal: true
    run: once
    vars:
      OS: iossimulator
      ARCH: amd64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-iossimulator-amd64
    cmds:
      - task: archives-libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-iossimulator-arm64:
    internal: true
    run: once
    vars:
      OS: iossimulator
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-iossimulator-arm64
    cmds:
      - task: archives-libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  archives-xcframeworks:
    label: archives-xcframeworks-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    vars:
      XCFRAMEWORKS_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/xcframeworks"
      ARCHIVES_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/archives/xcframeworks"
    sources:
      - "{{.XCFRAMEWORKS_DIR}}/*.xcframework/*"
    generates:
      - "{{.ARCHIVES_DIR}}/*.tar.gz"
    cmds:
      - rm -rf "{{.ARCHIVES_DIR}}"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export VERSION={{.VERSION}}
        export TYPE=xcframeworks
        export FILES_DIR={{.XCFRAMEWORKS_DIR}}
        export ARCHIVES_DIR={{.ARCHIVES_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/archives/build.sh"

  archives-libs:
    label: archives-libs-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    vars:
      LIBS_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/libs"
      ARCHIVES_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/archives/libs"
    sources:
      - "{{.LIBS_DIR}}/*.dylib"
    generates:
      - "{{.ARCHIVES_DIR}}/*.tar.gz"
    cmds:
      - rm -rf "{{.ARCHIVES_DIR}}"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export VERSION={{.VERSION}}
        export TYPE=libs
        export FILES_DIR={{.LIBS_DIR}}
        export ARCHIVES_DIR={{.ARCHIVES_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/archives/build.sh"

  xcframeworks-macos-universal:
    internal: true
    run: once
    vars:
      FRAMEWORKS_MACOS_DIR: "{{.BUILD_DIR}}/macos/universal/frameworks"
      XCFRAMEWORKS_DIR: "{{.BUILD_DIR}}/macos/universal/xcframeworks"
    deps:
      - frameworks-macos-universal
    sources:
      - "{{.FRAMEWORKS_MACOS_DIR}}/*.framework/*"
    generates:
      - "{{.XCFRAMEWORKS_DIR}}/*.xcframework/*"
    cmds:
      - rm -rf "{{.XCFRAMEWORKS_DIR}}"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export FRAMEWORKS_MACOS_DIR={{.FRAMEWORKS_MACOS_DIR}}
        export XCFRAMEWORKS_DIR={{.XCFRAMEWORKS_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/xcframeworks/macos/create_xcframeworks.sh"

  xcframeworks-ios-universal:
    internal: true
    run: once
    vars:
      FRAMEWORKS_IOS_DIR: "{{.BUILD_DIR}}/ios/arm64/frameworks"
      FRAMEWORKS_IOSSIMULATOR_DIR: "{{.BUILD_DIR}}/iossimulator/universal/frameworks"
      XCFRAMEWORKS_DIR: "{{.BUILD_DIR}}/ios/universal/xcframeworks"
    deps:
      - frameworks-ios-arm64
      - frameworks-iossimulator-universal
    sources:
      - "{{.FRAMEWORKS_IOS_DIR}}/*.framework/*"
      - "{{.FRAMEWORKS_IOSSIMULATOR_DIR}}/*.framework/*"
    generates:
      - "{{.XCFRAMEWORKS_DIR}}/*.xcframework/*"
    cmds:
      - rm -rf "{{.XCFRAMEWORKS_DIR}}"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export FRAMEWORKS_IOS_DIR={{.FRAMEWORKS_IOS_DIR}}
        export FRAMEWORKS_IOSSIMULATOR_DIR={{.FRAMEWORKS_IOSSIMULATOR_DIR}}
        export XCFRAMEWORKS_DIR={{.XCFRAMEWORKS_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/xcframeworks/ios/create_xcframeworks.sh"

  frameworks-macos-universal:
    internal: true
    run: once
    vars:
      OS: macos
      ARCH: universal
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-macos-universal
    cmds:
      - task: frameworks
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  frameworks-ios-arm64:
    internal: true
    run: once
    vars:
      OS: ios
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-ios-arm64
    cmds:
      - task: frameworks
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  frameworks-iossimulator-universal:
    internal: true
    run: once
    vars:
      OS: iossimulator
      ARCH: universal
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-iossimulator-universal
    cmds:
      - task: frameworks
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  frameworks:
    label: frameworks-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    vars:
      LIBS_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/libs"
      FRAMEWORKS_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/frameworks"
    sources:
      - "{{.LIBS_DIR}}/*.dylib"
    generates:
      - "{{.FRAMEWORKS_DIR}}/*.framework/*"
    cmds:
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export OS={{.OS}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export LIBS_DIR={{.LIBS_DIR}}
        export FRAMEWORKS_DIR={{.FRAMEWORKS_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/frameworks/build.sh"

  libs-macos-universal:
    internal: true
    desc: merge {{.ARCH1}} & {{.ARCH2}} libs to universal
    run: once
    vars:
      OS: macos
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
      ARCH1: amd64
      ARCH2: arm64
      LIBS_ARCH1_DIR: "{{.TARGET_DIR}}/{{.ARCH1}}/libs"
      LIBS_ARCH2_DIR: "{{.TARGET_DIR}}/{{.ARCH2}}/libs"
      LIBS_UNIVERSAL_DIR: "{{.TARGET_DIR}}/universal/libs"
    deps:
      - libs-macos-amd64
      - libs-macos-arm64
    sources:
      - "{{.LIBS_ARCH1_DIR}}/*.dylib"
      - "{{.LIBS_ARCH2_DIR}}/*.dylib"
    generates:
      - "{{.LIBS_UNIVERSAL_DIR}}/*.dylib"
    cmds:
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export ARCH1={{.ARCH1}}
        export ARCH2={{.ARCH2}}
        export LIBS_ARCH1_DIR={{.LIBS_ARCH1_DIR}}
        export LIBS_UNIVERSAL_DIR={{.LIBS_UNIVERSAL_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/libs/build-universal.sh"

  libs-macos-amd64:
    internal: true
    run: once
    vars:
      OS: macos
      ARCH: amd64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - task: libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  libs-macos-arm64:
    internal: true
    run: once
    vars:
      OS: macos
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - task: libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  libs-ios-arm64:
    internal: true
    run: once
    vars:
      OS: ios
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - task: libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  libs-iossimulator-universal:
    internal: true
    desc: merge {{.ARCH1}} & {{.ARCH2}} libs to universal
    run: once
    vars:
      OS: iossimulator
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
      ARCH1: amd64
      ARCH2: arm64
      LIBS_ARCH1_DIR: "{{.TARGET_DIR}}/{{.ARCH1}}/libs"
      LIBS_ARCH2_DIR: "{{.TARGET_DIR}}/{{.ARCH2}}/libs"
      LIBS_UNIVERSAL_DIR: "{{.TARGET_DIR}}/universal/libs"
    deps:
      - libs-iossimulator-amd64
      - libs-iossimulator-arm64
    sources:
      - "{{.LIBS_ARCH1_DIR}}/*.dylib"
      - "{{.LIBS_ARCH2_DIR}}/*.dylib"
    generates:
      - "{{.LIBS_UNIVERSAL_DIR}}/*.dylib"
    cmds:
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export ARCH1={{.ARCH1}}
        export ARCH2={{.ARCH2}}
        export LIBS_ARCH1_DIR={{.LIBS_ARCH1_DIR}}
        export LIBS_UNIVERSAL_DIR={{.LIBS_UNIVERSAL_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/libs/build-universal.sh"

  libs-iossimulator-amd64:
    internal: true
    run: once
    vars:
      OS: iossimulator
      ARCH: amd64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - task: libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  libs-iossimulator-arm64:
    internal: true
    run: once
    vars:
      OS: iossimulator
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - task: libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  libs:
    desc: cleanup libs from `chroot/libs``
    label: libs-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    vars:
      LIBS_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/libs"
      SOURCES_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/sources"
      PREFIX: "{{.TARGET_DIR}}/{{.ARCH}}/chroot"
      PKG_CONFIG_PATH: "{{.PREFIX}}/lib/pkgconfig"
    deps:
      - task: mpv
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - "{{.PREFIX}}/lib/*.dylib"
    generates:
      - "{{.LIBS_DIR}}/*.dylib"
    cmds:
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export LIBS_DIR={{.LIBS_DIR}}
        export PREFIX={{.PREFIX}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/libs/build.sh"

  downloads:
    run: once
    sources:
      - downloads.lock
    generates:
      - downloads/*.tar.*
    cmds:
      - |
        set -e

        rm -f downloads/.*.tmp
        rm -f downloads/*.tar.*
        go run cmd/downloads/main.go downloads.lock downloads

  extract:
    internal: true
    run: when_changed
    cmds:
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export PKG_NAME={{.PKG_NAME}}
        export TARGET_DIR={{.TARGET_DIR}}
        sh "{{.PROJECT_DIR}}/scripts/extract/build.sh"

  links:
    internal: true
    run: when_changed
    vars:
      BINARIES: meson
        ninja
        cmake
    status:
      - |
        set -e

        export BINARIES="{{.BINARIES}}"
        export TOOLS_PREFIX={{.TOOLS_PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/links/status.sh"
    cmds:
      - |
        set -e

        export BINARIES="{{.BINARIES}}"
        export TOOLS_PREFIX={{.TOOLS_PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/links/build.sh"

  pkg-config:
    internal: true
    run: when_changed
    deps:
      - downloads
    sources:
      - downloads/pkg-config-*.tar.*
    generates:
      - "{{.TOOLS_PREFIX}}/bin/pkg-config"
    cmds:
      - rm -rf "{{.TOOLS_SOURCES_DIR}}/pkg-config"
      - task: extract
        vars:
          PKG_NAME: pkg-config
          TARGET_DIR: "{{.TOOLS_SOURCES_DIR}}/pkg-config"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        export OS=macos
        export ARCH={{ARCH}}
        export TOOLS_SOURCES_DIR={{.TOOLS_SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export TOOLS_PREFIX={{.TOOLS_PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/pkg-config/build.sh"

  tools:
    internal: true
    run: once
    deps:
      - links
      - pkg-config

  freetype:
    label: freetype-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: harfbuzz
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/freetype-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libfreetype.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/freetype"
      - task: extract
        vars:
          PKG_NAME: freetype
          TARGET_DIR: "{{.SOURCES_DIR}}/freetype"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/freetype/build.sh"

  fribidi:
    label: fribidi-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/fribidi-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libfribidi.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/fribidi"
      - task: extract
        vars:
          PKG_NAME: fribidi
          TARGET_DIR: "{{.SOURCES_DIR}}/fribidi"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/fribidi/build.sh"

  harfbuzz:
    label: harfbuzz-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/harfbuzz-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libharfbuzz.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/harfbuzz"
      - task: extract
        vars:
          PKG_NAME: harfbuzz
          TARGET_DIR: "{{.SOURCES_DIR}}/harfbuzz"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/harfbuzz/build.sh"

  libass:
    label: libass-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: freetype
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: fribidi
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: harfbuzz
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/libass-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libass.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/libass"
      - task: extract
        vars:
          PKG_NAME: libass
          TARGET_DIR: "{{.SOURCES_DIR}}/libass"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/libass/build.sh"

  libressl:
    label: libressl-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/libressl-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libcrypto.dylib"
      - "{{.PREFIX}}/lib/libssl.dylib"
      - "{{.PREFIX}}/lib/libtls.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/libressl"
      - task: extract
        vars:
          PKG_NAME: libressl
          TARGET_DIR: "{{.SOURCES_DIR}}/libressl"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/libressl/build.sh"

  ffmpeg:
    label: ffmpeg-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: libressl
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/ffmpeg-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libavcodec.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/ffmpeg"
      - task: extract
        vars:
          PKG_NAME: ffmpeg
          TARGET_DIR: "{{.SOURCES_DIR}}/ffmpeg"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/ffmpeg/build.sh"

  uchardet:
    label: uchardet-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/uchardet-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libuchardet.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/uchardet"
      - task: extract
        vars:
          PKG_NAME: uchardet
          TARGET_DIR: "{{.SOURCES_DIR}}/uchardet/subprojects/uchardet"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/uchardet/build.sh"

  mpv:
    label: mpv-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: libass
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: ffmpeg
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: uchardet
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/mpv-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libmpv.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/mpv"
      - task: extract
        vars:
          PKG_NAME: mpv
          TARGET_DIR: "{{.SOURCES_DIR}}/mpv"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        export OS={{.OS}}
        export ARCH={{.ARCH}}
        export SOURCES_DIR={{.SOURCES_DIR}}
        export PROJECT_DIR={{.PROJECT_DIR}}
        export PREFIX={{.PREFIX}}
        sh "{{.PROJECT_DIR}}/scripts/mpv/build.sh"

  update-downloads-lock:
    run: once
    vars:
      DEPS: pkg-config
        mpv
        uchardet
        libass
        freetype
        harfbuzz
        fribidi
        ffmpeg
        libressl
    cmds:
      - go run cmd/update-downloads-lock/main.go {{.DEPS}} > downloads.lock

  tool-versions:
    run: once
    cmds:
      - go run cmd/tool-versions/main.go

  clean:
    run: once
    cmds:
      - rm -rf build

  clear:
    run: once
    deps:
      - clean
    cmds:
      - rm -rf .task
      - rm -rf downloads/*
