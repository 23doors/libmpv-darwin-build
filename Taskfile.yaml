version: "3"

vars:
  PWD:
    sh: pwd
  TERM:
    sh: echo $TERM
  VERSION:
    sh: echo $VERSION
  UNSETENV: |
    # unset all env vars
    for i in $(env | awk -F"=" '{print $1}') ; do unset $i ; done
  PROJECT_DIR: "{{.PWD}}"
  BUILD_DIR: "{{.PROJECT_DIR}}/build"
  TOOLS_DIR: "{{.BUILD_DIR}}/tools"
  TOOLS_PREFIX: "{{.TOOLS_DIR}}/chroot"
  TOOLS_SOURCES_DIR: "{{.TOOLS_DIR}}/sources"
  PATH: /bin:/usr/bin:{{.TOOLS_PREFIX}}/bin

tasks:
  default:
    deps:
      - build-darwin
      - release-note

  build-darwin:
    run: once
    platforms:
      - darwin
    deps:
      - packages-darwin-universal
      - packages-darwin-amd64
      - packages-darwin-arm64

  build-darwin-universal:
    run: once
    platforms:
      - darwin
    deps:
      - packages-darwin-universal

  build-darwin-amd64:
    run: once
    platforms:
      - darwin
    deps:
      - packages-darwin-amd64

  build-darwin-arm64:
    run: once
    platforms:
      - darwin
    deps:
      - packages-darwin-arm64

  packages-darwin-universal:
    internal: true
    run: once
    vars:
      OS: darwin
      ARCH: universal
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-darwin-universal
    cmds:
      - task: packages
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  packages-darwin-amd64:
    internal: true
    run: once
    vars:
      OS: darwin
      ARCH: amd64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-darwin-amd64
    cmds:
      - task: packages
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  packages-darwin-arm64:
    internal: true
    run: once
    vars:
      OS: darwin
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - libs-darwin-arm64
    cmds:
      - task: packages
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  packages:
    label: packages-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    vars:
      LIBS_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/libs"
      PACKAGES_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/packages"
    sources:
      - "{{.LIBS_DIR}}/*.dylib"
    generates:
      - "{{.PACKAGES_DIR}}/*.tar.gz"
    cmds:
      - |
        set -e

        if [ -z "{{.VERSION}}" ]; then \
          echo "package creation skipped for {{.OS}}/{{.ARCH}} (env var VERSION required)" ; \
          exit 0; \
        fi

        NAME=libmpv-{{.VERSION}}-{{.OS}}-{{.ARCH}}

        mkdir -p "{{.PACKAGES_DIR}}/$NAME"
        cp -r "{{.LIBS_DIR}}"/*.dylib "{{.PACKAGES_DIR}}"/$NAME/

        cd "{{.PACKAGES_DIR}}"
        tar -czvf $NAME.tar.gz $NAME

  libs-darwin-universal:
    internal: true
    desc: merge {{.ARHC1}} & {{.ARHC2}} libs to {{.ARHC3}}
    run: once
    vars:
      OS: darwin
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
      ARHC1: amd64
      ARHC2: arm64
      ARHC3: universal
      LIBS_ARHC1_DIR: "{{.TARGET_DIR}}/{{.ARHC1}}/libs"
      LIBS_ARHC2_DIR: "{{.TARGET_DIR}}/{{.ARHC2}}/libs"
      LIBS_ARHC3_DIR: "{{.TARGET_DIR}}/{{.ARHC3}}/libs"
    deps:
      - libs-darwin-amd64
      - libs-darwin-arm64
    sources:
      - "{{.LIBS_ARHC1_DIR}}/*.dylib"
      - "{{.LIBS_ARHC2_DIR}}/*.dylib"
    generates:
      - "{{.LIBS_ARHC3_DIR}}/*.dylib"
    cmds:
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        mkdir -p "{{.LIBS_ARHC3_DIR}}"

        find "{{.LIBS_ARHC1_DIR}}" \
          -type f -name '*.dylib' \
          -exec \
          sh -c ' \
            lipo \
              -create \
                "{}" \
                $(echo "{}" | sed -r "s|{{.ARHC1}}|{{.ARHC2}}|g") \
              -output \
                $(echo "{}" | sed -r "s|{{.ARHC1}}|{{.ARHC3}}|g") \
          ' \
        \;

  libs-darwin-amd64:
    internal: true
    run: once
    vars:
      OS: darwin
      ARCH: amd64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - task: libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  libs-darwin-arm64:
    internal: true
    run: once
    vars:
      OS: darwin
      ARCH: arm64
      TARGET_DIR: "{{.BUILD_DIR}}/{{.OS}}"
    deps:
      - task: libs
        vars:
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
          TARGET_DIR: "{{.TARGET_DIR}}"

  libs:
    desc: cleanup libs from `chroot/libs``
    label: libs-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    vars:
      LIBS_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/libs"
      SOURCES_DIR: "{{.TARGET_DIR}}/{{.ARCH}}/sources"
      PREFIX: "{{.TARGET_DIR}}/{{.ARCH}}/chroot"
      PKG_CONFIG_PATH: "{{.PREFIX}}/lib/pkgconfig"
    deps:
      - task: mpv
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - "{{.PREFIX}}/lib/*.dylib"
    generates:
      - "{{.LIBS_DIR}}/*.dylib"
    cmds:
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        rm -rf "{{.LIBS_DIR}}"
        mkdir -p "{{.LIBS_DIR}}"

        # copy dylibs except '*-subset.*.dylib'
        find "{{.PREFIX}}/lib" \
          -type f -name '*.dylib' \
          ! -name '*-subset.*.dylib' \
          -exec \
          cp "{}" "{{.LIBS_DIR}}" \
        \;

        # libfoo.100.99.88.dylib -> libfoo.100.dylib
        find {{.LIBS_DIR}} -type f -name '*.dylib' -exec \
          sh -c 'mv "{}" $(echo "{}" | sed -r "s|([0-9]+)(\.[0-9]+)*|\1|g")' \
        \;

        mv "{{.LIBS_DIR}}"/libmpv.*.dylib "{{.LIBS_DIR}}/libmpv.dylib"
        install_name_tool -id @rpath/libmpv.dylib "{{.LIBS_DIR}}/libmpv.dylib"

        ./scripts/libs/relink_dylibs.sh "{{.PREFIX}}/lib" "{{.LIBS_DIR}}"

        codesign --remove "{{.LIBS_DIR}}"/*.dylib

  downloads:
    run: once
    sources:
      - downloads.lock
    generates:
      - downloads/*.tar.*
    cmds:
      - |
        set -e

        rm -f downloads/.*.tmp
        rm -f downloads/*.tar.*
        go run cmd/download/download.go downloads.lock downloads

  extract:
    internal: true
    run: when_changed
    cmds:
      - |
        set -e

        mkdir -p {{.TARGET_DIR}}
        find downloads -type f -name '{{.PKG_NAME}}-*.tar.*' -exec \
          tar \
            -xvf {} \
            --strip-components 1 \
            -C {{.TARGET_DIR}} \
        \;

  links:
    internal: true
    run: when_changed
    vars:
      BINARIES: meson
        ninja
        cmake
    status:
      - |
        set -e

        # check BINARY presence in \$TOOLS_PREFIX/bin
        for BINARY in {{.BINARIES}} ; do \
          test -f {{.TOOLS_PREFIX}}/bin/$BINARY ; \
        done
    cmds:
      - |
        set -e

        mkdir -p {{.TOOLS_PREFIX}}/bin

        # check BINARY presence in PATH
        for BINARY in {{.BINARIES}} ; do \
          [ -z $(which $BINARY) ] \
            && echo $BINARY not found in \$PATH \
            && false || true ; \
        done

        # sym link BINARY
        for BINARY in {{.BINARIES}} ; do \
          [ ! -h {{.TOOLS_PREFIX}}/bin/$BINARY ] \
            && ln -s $(which $BINARY) {{.TOOLS_PREFIX}}/bin/$BINARY \
            || true ; \
        done

  pkg-config:
    internal: true
    run: when_changed
    deps:
      - downloads
    sources:
      - downloads/pkg-config-*.tar.*
    generates:
      - "{{.TOOLS_PREFIX}}/bin/pkg-config"
    cmds:
      - rm -rf "{{.TOOLS_SOURCES_DIR}}/pkg-config"
      - task: extract
        vars:
          PKG_NAME: pkg-config
          TARGET_DIR: "{{.TOOLS_SOURCES_DIR}}/pkg-config"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}

        cd {{.TOOLS_SOURCES_DIR}}/pkg-config

        cp {{.PROJECT_DIR}}/scripts/pkg-config/meson.build ./meson.build
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{OS}}-{{ARCH}}.ini \
          --prefix="{{.TOOLS_PREFIX}}"

        meson compile -C build pkg-config

        # manual install to preserve symlinks (meson install -C build)
        mkdir -p '{{.TOOLS_PREFIX}}'
        cp -R build/dist'{{.TOOLS_PREFIX}}'/* '{{.TOOLS_PREFIX}}'/

  tools:
    internal: true
    run: once
    deps:
      - links
      - pkg-config

  freetype:
    label: freetype-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: harfbuzz
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/freetype-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libfreetype.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/freetype"
      - task: extract
        vars:
          PKG_NAME: freetype
          TARGET_DIR: "{{.SOURCES_DIR}}/freetype"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/freetype
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix="{{.PREFIX}}" \
          -Dbrotli=disabled \
          -Dbzip2=disabled \
          -Dharfbuzz=enabled \
          -Dmmap=disabled \
          -Dpng=disabled \
          -Dtests=disabled \
          -Dzlib=disabled
        meson compile -C build
        meson install -C build

  fribidi:
    label: fribidi-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/fribidi-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libfribidi.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/fribidi"
      - task: extract
        vars:
          PKG_NAME: fribidi
          TARGET_DIR: "{{.SOURCES_DIR}}/fribidi"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/fribidi
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix="{{.PREFIX}}" \
          -Ddeprecated=false \
          -Ddocs=false \
          -Dbin=false \
          -Dtests=false \
          -Dfuzzer_ldflags=
        meson compile -C build
        meson install -C build

  harfbuzz:
    label: harfbuzz-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/harfbuzz-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libharfbuzz.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/harfbuzz"
      - task: extract
        vars:
          PKG_NAME: harfbuzz
          TARGET_DIR: "{{.SOURCES_DIR}}/harfbuzz"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/harfbuzz
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix="{{.PREFIX}}" \
          -Dglib=disabled \
          -Dgobject=disabled \
          -Dcairo=disabled \
          -Dchafa=disabled \
          -Dicu=disabled \
          -Dgraphite=disabled \
          -Dgraphite2=disabled \
          -Dfreetype=disabled \
          -Dgdi=disabled \
          -Ddirectwrite=disabled \
          -Dcoretext=enabled \
          -Dtests=disabled \
          -Dintrospection=disabled \
          -Ddocs=disabled \
          -Dbenchmark=disabled \
          -Dicu_builtin=false \
          -Dexperimental_api=false \
          -Dragel_subproject=false \
          -Dfuzzer_ldflags=
        meson compile -C build
        meson install -C build

  libass:
    label: libass-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: freetype
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: fribidi
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: harfbuzz
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/libass-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libass.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/libass"
      - task: extract
        vars:
          PKG_NAME: libass
          TARGET_DIR: "{{.SOURCES_DIR}}/libass"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/libass

        cp {{.PROJECT_DIR}}/scripts/libass/meson.build ./meson.build
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix="{{.PREFIX}}"

        meson compile -C build libass

        # manual install to preserve symlinks (meson install -C build)
        mkdir -p '{{.PREFIX}}'
        cp -R build/dist'{{.PREFIX}}'/* '{{.PREFIX}}'/

  libressl:
    label: libressl-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/libressl-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libcrypto.dylib"
      - "{{.PREFIX}}/lib/libssl.dylib"
      - "{{.PREFIX}}/lib/libtls.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/libressl"
      - task: extract
        vars:
          PKG_NAME: libressl
          TARGET_DIR: "{{.SOURCES_DIR}}/libressl"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/libressl

        cp {{.PROJECT_DIR}}/scripts/libressl/meson.build ./meson.build
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix="{{.PREFIX}}"

        meson compile -C build libressl

        # fix file permissions
        chmod 755 build/dist'{{.PREFIX}}'/lib/*

        # manual install to preserve symlinks (meson install -C build)
        mkdir -p '{{.PREFIX}}'
        cp -R build/dist'{{.PREFIX}}'/* '{{.PREFIX}}'/

  ffmpeg:
    label: ffmpeg-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: libressl
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/ffmpeg-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libavcodec.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/ffmpeg"
      - task: extract
        vars:
          PKG_NAME: ffmpeg
          TARGET_DIR: "{{.SOURCES_DIR}}/ffmpeg"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/ffmpeg

        cp {{.PROJECT_DIR}}/scripts/ffmpeg/meson.build ./meson.build
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix="{{.PREFIX}}"

        meson compile -C build ffmpeg

        # manual install to preserve symlinks (meson install -C build)
        mkdir -p '{{.PREFIX}}'
        cp -R build/dist'{{.PREFIX}}'/* '{{.PREFIX}}'/

  uchardet:
    label: uchardet-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
    sources:
      - downloads/uchardet-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libuchardet.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/uchardet"
      - task: extract
        vars:
          PKG_NAME: uchardet
          TARGET_DIR: "{{.SOURCES_DIR}}/uchardet/subprojects/uchardet"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/uchardet

        # cross build with meson
        cp {{.PROJECT_DIR}}/scripts/uchardet/meson.build ./meson.build
        meson setup build_cross \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix='{{.PREFIX}}'
        meson compile -C build_cross uchardet

        # native build with cmake
        cmake ./subprojects/uchardet \
          -B build_native \
          -DCMAKE_INSTALL_PREFIX='{{.PREFIX}}' \
          -DBUILD_STATIC=OFF
        make -C build_native
        DESTDIR=$PWD/dist make -C build_native install

        # remove unecessary files
        rm -rf 'dist/{{.PREFIX}}/bin'
        rm -rf 'dist/{{.PREFIX}}/lib/cmake'
        rm -rf 'dist/{{.PREFIX}}/share'

        # get dylib id
        DYLIB_FILE=$(find 'dist{{.PREFIX}}/lib' -type f -name '*.dylib')
        DYLIB_ID=$(otool -l "$DYLIB_FILE" | grep ' name ' | cut -d ' ' -f 11 | head -n +1)

        # replace native dylib by cross dylib & update id
        cp 'build_cross/subprojects/uchardet/liblibuchardet.dylib' "$DYLIB_FILE"
        install_name_tool -id "$DYLIB_ID" "$DYLIB_FILE"

        # manual install to preserve symlinks
        mkdir -p '{{.PREFIX}}'
        cp -R dist'{{.PREFIX}}'/* '{{.PREFIX}}'/

  mpv:
    label: mpv-{{.OS}}-{{.ARCH}}
    internal: true
    run: when_changed
    deps:
      - tools
      - downloads
      - task: libass
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: ffmpeg
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
      - task: uchardet
        vars:
          SOURCES_DIR: "{{.SOURCES_DIR}}"
          PREFIX: "{{.PREFIX}}"
          PKG_CONFIG_PATH: "{{.PKG_CONFIG_PATH}}"
          OS: "{{.OS}}"
          ARCH: "{{.ARCH}}"
    sources:
      - downloads/mpv-*.tar.*
    generates:
      - "{{.PREFIX}}/lib/libmpv.dylib"
    cmds:
      - rm -rf "{{.SOURCES_DIR}}/mpv"
      - task: extract
        vars:
          PKG_NAME: mpv
          TARGET_DIR: "{{.SOURCES_DIR}}/mpv"
      - |
        set -e

        {{.UNSETENV}}
        export PATH={{.PATH}}
        export TERM={{.TERM}}
        export PKG_CONFIG_PATH={{.PKG_CONFIG_PATH}}

        cd {{.SOURCES_DIR}}/mpv
        meson setup build \
          --cross-file {{.PROJECT_DIR}}/cross-files/{{.OS}}-{{.ARCH}}.ini \
          --prefix="{{.PREFIX}}" \
          `# booleans` \
          -Dgpl=false            `# GPL (version 2 or later) build` \
          -Dcplayer=false        `# mpv CLI player` \
          -Dlibmpv=true          `# libmpv library` \
          -Dbuild-date=true      `# whether to include binary compile time` \
          -Dtests=false          `# unit tests (development only)` \
          -Dta-leak-report=false `# enable ta leak report by default (development only)` \
          \
          `# misc features` \
          -Dcdda=disabled                    `# cdda support (libcdio)` \
          -Dcplugins=disabled                `# C plugins` \
          -Ddvbin=disabled                   `# DVB input module` \
          -Ddvdnav=disabled                  `# dvdnav support` \
          -Diconv=enabled                    `# iconv` \
          -Djavascript=disabled              `# Javascript (MuJS backend)` \
          -Dlcms2=disabled                   `# LCMS2 support` \
          -Dlibarchive=disabled              `# libarchive wrapper for reading zip files and more` \
          -Dlibavdevice=disabled             `# libavdevice` \
          -Dlibbluray=disabled               `# Bluray support` \
          -Dlua=disabled                     `# Lua` \
          -Dpthread-debug=disabled           `# pthread runtime debugging wrappers` \
          -Drubberband=disabled              `# librubberband support` \
          -Dsdl2=disabled                    `# SDL2` \
          -Dsdl2-gamepad=disabled            `# SDL2 gamepad input` \
          -Dstdatomic=disabled               `# C11 stdatomic.h` \
          -Duchardet=enabled                 `# uchardet support` \
          -Duwp=disabled                     `# Universal Windows Platform` \
          -Dvapoursynth=disabled             `# VapourSynth filter bridge` \
          -Dvector=disabled                  `# GCC vector instructions` \
          -Dwin32-internal-pthreads=disabled `#internal pthread wrapper for win32 (Vista+)` \
          -Dzimg=disabled                    `# libzimg support (high quality software scaler)` \
          -Dzlib=disabled                    `# zlib` \
          \
          `# audio output features` \
          -Dalsa=disabled       `# ALSA audio output` \
          -Daudiounit=disabled  `# AudioUnit output for iOS` \
          -Dcoreaudio=enabled   `# CoreAudio audio output` \
          -Djack=disabled       `# JACK audio output` \
          -Dopenal=disabled     `# OpenAL audio output` \
          -Dopensles=disabled   `# OpenSL ES audio output` \
          -Doss-audio=disabled  `# OSSv4 audio output` \
          -Dpipewire=disabled   `# PipeWire audio output` \
          -Dpulse=disabled      `# PulseAudio audio output` \
          -Dsdl2-audio=disabled `# SDL2 audio output` \
          -Dsndio=disabled      `# sndio audio output` \
          -Dwasapi=disabled     `# WASAPI audio output` \
          \
          `# video output features` \
          -Dcaca=disabled            `# CACA` \
          -Dcocoa=enabled            `# Cocoa` \
          -Dd3d11=disabled           `# Direct3D 11 video output` \
          -Ddirect3d=disabled        `# Direct3D support` \
          -Ddrm=disabled             `# DRM` \
          -Degl=disabled             `# EGL 1.4` \
          -Degl-android=disabled     `# Android EGL support` \
          -Degl-angle=disabled       `# OpenGL ANGLE headers` \
          -Degl-angle-lib=disabled   `# OpenGL Win32 ANGLE library` \
          -Degl-angle-win32=disabled `# OpenGL Win32 ANGLE Backend` \
          -Degl-drm=disabled         `# OpenGL DRM EGL Backend` \
          -Degl-wayland=disabled     `# OpenGL Wayland Backend` \
          -Degl-x11=disabled         `# OpenGL X11 EGL Backend` \
          -Dgbm=disabled             `# GBM` \
          -Dgl=enabled               `# OpenGL context support` \
          -Dgl-cocoa=enabled         `# gl-cocoa` \
          -Dgl-dxinterop=disabled    `# OpenGL/DirectX Interop Backend` \
          -Dgl-win32=disabled        `# OpenGL Win32 Backend` \
          -Dgl-x11=disabled          `# OpenGL X11/GLX (deprecated/legacy)` \
          -Djpeg=disabled            `# JPEG support` \
          -Dlibplacebo=disabled      `# libplacebo support` \
          -Drpi=disabled             `# Raspberry Pi support` \
          -Dsdl2-video=disabled      `# SDL2 video output` \
          -Dshaderc=disabled         `# libshaderc SPIR-V compiler` \
          -Dsixel=disabled           `# Sixel` \
          -Dspirv-cross=disabled     `# SPIRV-Cross SPIR-V shader converter` \
          -Dplain-gl=enabled         `# OpenGL without platform-specific code (e.g. for libmpv)` \
          -Dvdpau=disabled           `# VDPAU acceleration` \
          -Dvdpau-gl-x11=disabled    `# VDPAU with OpenGl/X11` \
          -Dvaapi=disabled           `# VAAPI acceleration` \
          -Dvaapi-drm=disabled       `# VAAPI (DRM/EGL support)` \
          -Dvaapi-wayland=disabled   `# VAAPI (Wayland support)` \
          -Dvaapi-x11=disabled       `# VAAPI (X11 support)` \
          -Dvaapi-x-egl=disabled     `# VAAPI EGL on X11` \
          -Dvulkan=disabled          `# Vulkan context support` \
          -Dwayland=disabled         `# Wayland` \
          -Dx11=disabled             `# X11` \
          -Dxv=disabled              `# Xv video output` \
          \
          `# hwaccel features` \
          -Dandroid-media-ndk=disabled `# Android Media APIs` \
          -Dcuda-hwaccel=disabled      `# CUDA acceleration` \
          -Dcuda-interop=disabled      `# CUDA with graphics interop` \
          -Dd3d-hwaccel=disabled       `# D3D11VA hwaccel` \
          -Dd3d9-hwaccel=disabled      `# DXVA2 hwaccel` \
          -Dgl-dxinterop-d3d9=disabled `# OpenGL/DirectX Interop Backend DXVA2 interop` \
          -Dios-gl=disabled            `# iOS OpenGL ES hardware decoding interop support` \
          -Drpi-mmal=disabled          `# Raspberry Pi MMAL hwaccel` \
          -Dvideotoolbox-gl=enabled   `# Videotoolbox with OpenG` \
          \
          `# macOS features` \
          -Dmacos-10-11-features=enabled   `# macOS 10.11 SDK Features` \
          -Dmacos-10-12-2-features=enabled `# macOS 10.12.2 SDK Features` \
          -Dmacos-10-14-features=enabled   `# macOS 10.14 SDK Features` \
          -Dmacos-cocoa-cb=disabled        `# macOS libmpv backend` \
          -Dmacos-media-player=disabled    `# macOS Media Player support` \
          -Dmacos-touchbar=disabled        `# macOS Touch Bar support` \
          -Dswift-build=disabled           `# macOS Swift build tools` \
          -Dswift-flags=                   `# Optional Swift compiler flags` \
          \
          `# manpages` \
          -Dhtml-build=disabled    `# html manual generation` \
          -Dmanpage-build=disabled `# manpage generation` \
          -Dpdf-build=disabled     `# pdf manual generation`
        meson compile -C build
        meson install -C build

  update-downloads-lock:
    run: once
    vars:
      DEPS: pkg-config
        mpv
        uchardet
        libass
        freetype
        harfbuzz
        fribidi
        ffmpeg
        libressl
    cmds:
      - go run cmd/update/update.go {{.DEPS}} > downloads.lock

  tool-versions:
    run: once
    cmds:
      - go run cmd/tool-versions/main.go

  release-note:
    run: once
    cmds:
      - go run cmd/release-note/main.go downloads.lock > {{.BUILD_DIR}}/release-note.md

  clean:
    run: once
    cmds:
      - rm -rf build

  clear:
    run: once
    deps:
      - clean
    cmds:
      - rm -rf .task
      - rm -rf downloads/*
